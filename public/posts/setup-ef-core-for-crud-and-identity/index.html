<!DOCTYPE html>
<html lang="en-us">

<head>
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-179561110-1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];

        function gtag() {
            dataLayer.push(arguments);
        }
        gtag('js', new Date());
        gtag('config', 'UA-179561110-1');
    </script>
    
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="X-UA-Compatible" content="IE=edge;chrome=1"> 
    <link rel="icon" href="/images/me.gif" type="image/gif">
    <title>Tutorial: Setup of Entity Framework (EF) core for CRUD and authentication with Razor pages</title>
     
    
    <meta name="author" content="map[name:Sorush Khajepor]">
    
    
    
    <link rel="stylesheet" href="https://iamsorush.com/css/style.min.css">
     

</head>

<body>
    
<div class="read-progress-container">
	<div class="progress-bar" id="myBar"></div>
</div>
<header class="header-black">
	<div class="container">

	<div>
		<div class="display-flex flex-column left-horizontal">
			<a class="scale-left-sm" href="https://iamsorush.com/">Sorush Khajepor</a>
			<span class="text-shadow-1">Numerical programming and app development</span>
		</div>
		<div class="display-flex align-center justify-start justify-md-end">	
			<a href="https://github.com/sorush-khajepor" class="mr-1 icon" aria-label="Github">
				<svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg"><path fill="white" d="M512 0C229.25 0 0 229.25 0 512c0 226.25 146.688 418.125 350.156 485.812 25.594 4.688 34.938-11.125 34.938-24.625 0-12.188-0.469-52.562-0.719-95.312C242 908.812 211.906 817.5 211.906 817.5c-23.312-59.125-56.844-74.875-56.844-74.875-46.531-31.75 3.53-31.125 3.53-31.125 51.406 3.562 78.47 52.75 78.47 52.75 45.688 78.25 119.875 55.625 149 42.5 4.654-33 17.904-55.625 32.5-68.375C304.906 725.438 185.344 681.5 185.344 485.312c0-55.938 19.969-101.562 52.656-137.406-5.219-13-22.844-65.094 5.062-135.562 0 0 42.938-13.75 140.812 52.5 40.812-11.406 84.594-17.031 128.125-17.219 43.5 0.188 87.312 5.875 128.188 17.281 97.688-66.312 140.688-52.5 140.688-52.5 28 70.531 10.375 122.562 5.125 135.5 32.812 35.844 52.625 81.469 52.625 137.406 0 196.688-119.75 240-233.812 252.688 18.438 15.875 34.75 47 34.75 94.75 0 68.438-0.688 123.625-0.688 140.5 0 13.625 9.312 29.562 35.25 24.562C877.438 930 1024 738.125 1024 512 1024 229.25 794.75 0 512 0z"/></svg>
			</a>
			<a href="https://twitter.com/KhSorush" class="mr-1 icon" aria-label="Twitter">
				<svg id="Logo_FIXED" data-name="Logo â€” FIXED" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 400 400"><defs><style>.cls-1{fill:none;}.cls-2{fill:#1da1f2;}</style></defs><title>Twitter_Logo_Blue</title><rect class="cls-1" width="400" height="400"/><path class="cls-2" d="M153.62,301.59c94.34,0,145.94-78.16,145.94-145.94,0-2.22,0-4.43-.15-6.63A104.36,104.36,0,0,0,325,122.47a102.38,102.38,0,0,1-29.46,8.07,51.47,51.47,0,0,0,22.55-28.37,102.79,102.79,0,0,1-32.57,12.45,51.34,51.34,0,0,0-87.41,46.78A145.62,145.62,0,0,1,92.4,107.81a51.33,51.33,0,0,0,15.88,68.47A50.91,50.91,0,0,1,85,169.86c0,.21,0,.43,0,.65a51.31,51.31,0,0,0,41.15,50.28,51.21,51.21,0,0,1-23.16.88,51.35,51.35,0,0,0,47.92,35.62,102.92,102.92,0,0,1-63.7,22A104.41,104.41,0,0,1,75,278.55a145.21,145.21,0,0,0,78.62,23"/></svg>
			</a>
			<a href="https://scholar.google.co.uk/citations?user=16Y7-NsAAAAJ&hl=en" class="mr-1 icon" aria-label="Google Scholar">
				<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><g data-name="Layer 2" id="Layer_2"><polygon fill="white" points="0.54 9 5 10.98 7 11.87 12 14.09 17 11.87 19 10.98 20 10.54 20 16 22 16 22 9.65 23.46 9 12 3.91 0.54 9"/><path fill="white" d="M18.45,18.89l.55-.27V13.17l-7,3.11L5,13.17v5.45l.55.27a14.45,14.45,0,0,0,12.9,0Z"/></g></svg>
			</a>
			<a href="https://stackoverflow.com/users/2543510/sorush" class="mr-1 icon" aria-label="Stackoverflow">
				<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 120 120"><style>.st0{fill:#bcbbbb}.st1{fill:#f48023}</style><path class="st0" d="M84.4 93.8V70.6h7.7v30.9H22.6V70.6h7.7v23.2z"/><path class="st1" d="M38.8 68.4l37.8 7.9 1.6-7.6-37.8-7.9-1.6 7.6zm5-18l35 16.3 3.2-7-35-16.4-3.2 7.1zm9.7-17.2l29.7 24.7 4.9-5.9-29.7-24.7-4.9 5.9zm19.2-18.3l-6.2 4.6 23 31 6.2-4.6-23-31zM38 86h38.6v-7.7H38V86z"/></svg>
			</a>
			<a href="https://www.linkedin.com/in/sorushkh/" class="mr-1 icon" aria-label="Linkedin">
				<svg enable-background="new 0 0 32 32" height="32px" id="Layer_1" version="1.0" viewBox="0 0 32 32" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><g><path d="M32,30c0,1.104-0.896,2-2,2H2c-1.104,0-2-0.896-2-2V2c0-1.104,0.896-2,2-2h28c1.104,0,2,0.896,2,2V30z" fill="#007BB5"/><g><rect fill="#FFFFFF" height="14" width="4" x="7" y="11"/><path d="M20.499,11c-2.791,0-3.271,1.018-3.499,2v-2h-4v14h4v-8c0-1.297,0.703-2,2-2c1.266,0,2,0.688,2,2v8h4v-7    C25,14,24.479,11,20.499,11z" fill="#FFFFFF"/><circle cx="9" cy="8" fill="#FFFFFF" r="2"/></g></g><g/><g/><g/><g/><g/><g/></svg>
			</a>
		</div>
	
	
	
    </div>
	</div>
</header>

<main>
	<article>
		<h1>Tutorial: Setup of Entity Framework (EF) core for CRUD and authentication with Razor pages</h1>
		<time>10 Oct 2020</time>
	</article>
	


    















<style>
    .post__hero{
        background-image: url('https://iamsorush.com/images/bird_hu3d03a01dcc18bc5be0e67db3d8d209a6_89602_430x250_fill_q70_box_smart1.jpg');
        height: 250px;
    }
    @media (min-width: 430px) {
        .post__hero{
        background-image: url('https://iamsorush.com/images/bird_hu3d03a01dcc18bc5be0e67db3d8d209a6_89602_768x400_fill_q70_box_smart1.jpg');
        height: 400px;
    }
    @media (min-width: 768px) {
        .post__hero{
        background-image: url('https://iamsorush.com/images/bird_hu3d03a01dcc18bc5be0e67db3d8d209a6_89602_1024x400_fill_q70_box_smart1.jpg');
        height: 400px;
    }
    }
    @media (min-width: 1024px) {
        .post__hero{
        background-image: url('https://iamsorush.com/images/bird_hu3d03a01dcc18bc5be0e67db3d8d209a6_89602_1280x400_fill_q70_box_smart1.jpg');
        height: 400px;
    }
    }
        
</style>
<div class="single-image post__hero"></div>
	<div class="article-nav" id="article-nav-id">
		<article class="overlay-top">
			<h2 id="goal">Goal</h2>
<p>In this post, step by step I create a web app using Entity Framework core and razor pages. The app is a library that admin can CRUD books info on a database and authenticated users can browse the records.</p>
<h2 id="result">Result</h2>


<video width=100% controls>
  <source src="/videos/ef_core_razor_crud.webm" type="video/webm">
Your browser does not support the video tag.
</video>

<h2 id="create-project">Create Project</h2>
<p>Open visual studio (mine is 2019 v16.7),  click on <em>Create a new project</em>  and follow the below pictures</p>


<img src="/images/EfCoreRazorCrud/select_project.webp" class="article-image"  />
<img src="/images/EfCoreRazorCrud/choose_razor_pages.webp" class="article-image"  />
<img src="/images/EfCoreRazorCrud/choose_name.webp" class="article-image"  />

<p>You will have a project like below</p>


<img src="/images/EfCoreRazorCrud/project_expolrer.webp" class="article-image"  />

<h2 id="create-ef-models">Create EF Models</h2>
<p>Models can contain any logic, but here models refer to tables in the database. Create the folder and files like below</p>


<img src="/images/EfCoreRazorCrud/model_folder.webp" class="article-image"  />

<p>When we defining a model (or table here), we not only consider columns of the table but also it&rsquo;s a relationship with other models (or tables). In this example, I only focus on the one-to-many relationship. Each book <em>has a</em> publisher, and  each publisher <em>has many</em> books.</p>
<h2 id="publisher-model">Publisher Model</h2>
<p>In <code>Publisher.cs</code> I have</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c#" data-lang="c#"><span style="color:#66d9ef">using</span> System;
<span style="color:#66d9ef">using</span> System.Collections.Generic;
<span style="color:#66d9ef">using</span> System.Linq;
<span style="color:#66d9ef">using</span> System.Threading.Tasks;

<span style="color:#66d9ef">namespace</span> EfCoreRazorCrud.Models
{
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Publisher</span>
    {
        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">int</span> Id { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; }
        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">string</span> Name { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; }

        <span style="color:#66d9ef">public</span> ICollection&lt;Book&gt; Books { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; }
    }
}
</code></pre></div><p><code>Id</code> must be named Id so EF set it as the <strong>primary key</strong> of <code>Publisher</code> table. <code>Name</code> is an example of a table column, other columns can be added by defining new properties like address and website. The last line will not create a column but is an EF core convention to create a one-to-many relationship that each publisher has many books. The properties which are not primitive type like <code>Book</code> are called <strong>navigation properties</strong>.</p>
<h2 id="book-model">Book Model</h2>
<p>We can mention the relationship in the Book class, see <code>Book.cs</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">using</span> System;
<span style="color:#66d9ef">using</span> System.Collections.Generic;
<span style="color:#66d9ef">using</span> System.ComponentModel.DataAnnotations.Schema;
<span style="color:#66d9ef">using</span> System.IO;
<span style="color:#66d9ef">using</span> System.Linq;
<span style="color:#66d9ef">using</span> System.Threading.Tasks;

<span style="color:#66d9ef">namespace</span> EfCoreRazorCrud.Models
{
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Book</span>
    {
		<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">int</span> Id { get; set; }
		<span style="color:#66d9ef">public</span> string Title { get; set; }

		<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">int</span> PublisherId { get; set; }
		<span style="color:#66d9ef">public</span> Publisher Publisher { get; set; }

		[NotMapped]
		<span style="color:#66d9ef">public</span> string FilePath
		{
			get { <span style="color:#66d9ef">return</span> Path.Combine(<span style="color:#e6db74">&#34;..&#34;</span>,<span style="color:#e6db74">&#34;pdf&#34;</span>,Title <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;.pdf&#34;</span>); }
		}

	}
}
</code></pre></div><p>In <code>Book</code> class, <code>Id</code> is the default primary key, <code>Title</code> is an arbitrary column in the Book table, more  can be added like author, year, and edition. <code>PublisherId</code> and <code>Publisher</code> are EF core conventions to have the relationship that each book has a publisher. Here <code>Publisher</code> is the navigation property. Note that the foreign class id and name must follow the convention <em>class name + Id</em> and <em>class name</em>.</p>
<p>If a property needs to be ignored by EF core, like <code>File Path</code>, annotate it with <code>[NotMapped]</code>.</p>
<p>To have a one-to-many relationship, mentioning the relationship in the <code>Book</code> class was not necessary. Personally, I prefer to have them in the <code>Book</code> class, so when a Book record is pulled from the database, automatically its corresponding publisher is found too.</p>
<h2 id="appuser-model">AppUser Model</h2>
<p><code>IdentityUser</code> is the default class that .Net core uses for user authentication. It contains username, email, password and related information. To add custom properties to the class we have to derive another class, <code>AppUser</code> here. <code>AppUser.cs</code> file contains</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">using</span> Microsoft.AspNetCore.Identity;
<span style="color:#66d9ef">using</span> System;
<span style="color:#66d9ef">using</span> System.Collections.Generic;
<span style="color:#66d9ef">using</span> System.Linq;
<span style="color:#66d9ef">using</span> System.Threading.Tasks;

<span style="color:#66d9ef">namespace</span> EfCoreRazorCrud.Models
{
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">AppUser</span> <span style="color:#f92672">:</span> IdentityUser
    {
        <span style="color:#66d9ef">public</span> string Name { get; set; }
    }
}
</code></pre></div><p>I added only property <code>Name</code> but any arbitrary column table can be added like <code>StartMembership</code>, <code>EndMembership</code>, or a one-to-many relationship with <code>Book</code> class to denote the books a user borrowed.</p>
<h2 id="appuser-in-startup">AppUser in Startup</h2>
<p>We have to modify <code>ConfigureServices</code> in <code>Startup.cs</code> so it uses the new <code>AppUser</code> class instead of the default <code>IdentityUser</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">ConfigureServices</span>(IServiceCollection services)
{
    <span style="color:#75715e">// some codes here ...
</span><span style="color:#75715e"></span>    services.AddDefaultIdentity<span style="color:#f92672">&lt;</span>Models.AppUser<span style="color:#f92672">&gt;</span>(
        options <span style="color:#f92672">=&gt;</span> options.SignIn.RequireConfirmedAccount <span style="color:#f92672">=</span> true)
        .AddRoles<span style="color:#f92672">&lt;</span>IdentityRole<span style="color:#f92672">&gt;</span>()
        .AddEntityFrameworkStores<span style="color:#f92672">&lt;</span>ApplicationDbContext<span style="color:#f92672">&gt;</span>();
    <span style="color:#75715e">// rest of the code ...
</span><span style="color:#75715e"></span>}
</code></pre></div><p>Make sure <code>.AddRoles&lt;IdentityRole&gt;()</code> is there as well which is necessary to have roles like admin, user, and so on.
There are other instances of <code>IdentityUser</code> in other files, simply find all them by <code>Ctrl+f</code> replace them with <code>Models.AppUser</code>. Otherwise you get some errors.</p>
<p>I found two of them in <code>_LoginPartials.cshtml</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c#" data-lang="c#">@inject SignInManager&lt;Models.AppUser&gt; SignInManager
@inject UserManager&lt;Models.AppUser&gt; UserManager
</code></pre></div><h2 id="applicationdbcontext">ApplicationDbContext</h2>
<p><code>ApplicationDbContext.cs</code> is changed to have the name of tables</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c#" data-lang="c#">    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ApplicationDbContext</span> 
                : IdentityDbContext&lt;AppUser&gt; <span style="color:#75715e">//Note AppUser
</span><span style="color:#75715e"></span>    {
        <span style="color:#66d9ef">public</span> ApplicationDbContext(DbContextOptions&lt;ApplicationDbContext&gt; options)
            : <span style="color:#66d9ef">base</span>(options)
        {
        }

        <span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">override</span> <span style="color:#66d9ef">void</span> OnModelCreating(ModelBuilder modelBuilder)
        {
            <span style="color:#66d9ef">base</span>.OnModelCreating(modelBuilder);

            SeedData(modelBuilder);
            AddAdmin(modelBuilder);
        }

        <span style="color:#66d9ef">public</span> DbSet&lt;Book&gt; Books { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; }
        <span style="color:#66d9ef">public</span> DbSet&lt;Publisher&gt; Publishers { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; }
	
	<span style="color:#75715e">// rest of the code ...
</span><span style="color:#75715e"></span>    }
}
</code></pre></div><h2 id="seed-data">Seed data</h2>
<p><code>SeedData</code> is created to initialize the database with some test records:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c#" data-lang="c#"><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> SeedData(ModelBuilder modelBuilder)
{
    modelBuilder.Entity&lt;Publisher&gt;().HasData(
        <span style="color:#66d9ef">new</span> Publisher() { Name = <span style="color:#e6db74">&#34;Little, Brown and Company&#34;</span>, Id = -<span style="color:#ae81ff">1</span> },
        <span style="color:#66d9ef">new</span> Publisher() { Name = <span style="color:#e6db74">&#34;Scholastic&#34;</span>, Id = -<span style="color:#ae81ff">2</span> }
        );
    modelBuilder.Entity&lt;Book&gt;().HasData(
        <span style="color:#66d9ef">new</span> Book() { Id = -<span style="color:#ae81ff">1</span>, Title = <span style="color:#e6db74">&#34;Harry Potter And The Cursed Child&#34;</span>, PublisherId = -<span style="color:#ae81ff">1</span> },
        <span style="color:#66d9ef">new</span> Book() { Id = -<span style="color:#ae81ff">2</span>, Title = <span style="color:#e6db74">&#34;The Hunger Games&#34;</span>, PublisherId = -<span style="color:#ae81ff">2</span> }
        );


    modelBuilder.Entity&lt;AppUser&gt;().HasData(

        <span style="color:#66d9ef">new</span> AppUser()
        {
            Id = Guid.NewGuid().ToString(),
            UserName = <span style="color:#e6db74">&#34;a@test.com&#34;</span>,
            NormalizedUserName = <span style="color:#e6db74">&#34;a@test.com&#34;</span>.ToUpper(),
            Email = <span style="color:#e6db74">&#34;a@test.com&#34;</span>,
            NormalizedEmail = <span style="color:#e6db74">&#34;a@test.com&#34;</span>.ToUpper(),
            EmailConfirmed = <span style="color:#66d9ef">true</span>,
            SecurityStamp = <span style="color:#66d9ef">string</span>.Empty,
            PasswordHash = HashPassword(<span style="color:#66d9ef">null</span>, <span style="color:#e6db74">&#34;pass&#34;</span>)
        });
}
        
</code></pre></div><p>and I added the admin here as well</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c#" data-lang="c#"><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> AddAdmin(ModelBuilder modelBuilder)
{
    <span style="color:#66d9ef">string</span> adminId = Guid.NewGuid().ToString();
    <span style="color:#66d9ef">string</span> roleId = Guid.NewGuid().ToString();


    modelBuilder.Entity&lt;IdentityRole&gt;()
    .HasData(<span style="color:#66d9ef">new</span> IdentityRole { 
        Id = roleId, 
        Name = <span style="color:#e6db74">&#34;Admin&#34;</span>, 
        NormalizedName = <span style="color:#e6db74">&#34;Admin&#34;</span>.ToUpper() });

    modelBuilder.Entity&lt;AppUser&gt;().HasData(
        <span style="color:#66d9ef">new</span> AppUser()
        {
            Id = adminId,
            Name = <span style="color:#e6db74">&#34;admin&#34;</span>,
            UserName = <span style="color:#e6db74">&#34;admin@test.com&#34;</span>,
            NormalizedUserName = <span style="color:#e6db74">&#34;admin@test.com&#34;</span>.ToUpper(),
            Email = <span style="color:#e6db74">&#34;admin@test.com&#34;</span>,
            NormalizedEmail = <span style="color:#e6db74">&#34;admin@test.com&#34;</span>.ToUpper(),
            EmailConfirmed = <span style="color:#66d9ef">true</span>,
            SecurityStamp = <span style="color:#66d9ef">string</span>.Empty,
            PasswordHash = HashPassword(<span style="color:#66d9ef">null</span>, <span style="color:#e6db74">&#34;pass&#34;</span>)

        });

    modelBuilder
    .Entity&lt;IdentityUserRole&lt;<span style="color:#66d9ef">string</span>&gt;&gt;()
    .HasData(<span style="color:#66d9ef">new</span> IdentityUserRole&lt;<span style="color:#66d9ef">string</span>&gt;
    {
        RoleId = roleId,
        UserId = adminId
    });
}
</code></pre></div><p><code>IdentityUser</code> saves the hash of a password, so I created the below function for that purpose:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c#" data-lang="c#"><span style="color:#66d9ef">string</span> HashPassword(AppUser user, <span style="color:#66d9ef">string</span> password)
{
    <span style="color:#66d9ef">var</span> hasher = <span style="color:#66d9ef">new</span> PasswordHasher&lt;AppUser&gt;();
    <span style="color:#66d9ef">return</span> hasher.HashPassword(user, password);
}
</code></pre></div><h2 id="seed-data-in-startup">Seed data in Startup</h2>
<p>we visit <code>Startup.cs</code> again and add the below function apply seed data on startup</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c#" data-lang="c#"><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> UpdateDatabase(IApplicationBuilder app)
{
    <span style="color:#66d9ef">using</span> (<span style="color:#66d9ef">var</span> serviceScope = app.ApplicationServices
        .GetRequiredService&lt;IServiceScopeFactory&gt;()
        .CreateScope())
    {
        <span style="color:#66d9ef">using</span> (<span style="color:#66d9ef">var</span> context = serviceScope.ServiceProvider.GetService&lt;ApplicationDbContext&gt;())
        {
            context.Database.Migrate();
        }
    }
}
</code></pre></div><p>and call it as below</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c#" data-lang="c#"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> Configure(IApplicationBuilder app, IWebHostEnvironment env)
{
    UpdateDatabase(app); <span style="color:#75715e">// should be first line
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// rest of code
</span><span style="color:#75715e"></span>}
</code></pre></div><h2 id="create-authorized-folders">Create authorized folders</h2>
<p>Now we create two folders in pages: <em>Admin</em> and <em>Users</em></p>


<img src="/images/EfCoreRazorCrud/admin_user_folder.webp" class="article-image"  />

<p>Any page in folder <em>Admin</em> is only visible by admin, and any page in <em>Users</em> folder is visible by authenticated users.
Let&rsquo;s define these rules in <code>Startup.cs</code>, the final <code>ConfigureServices</code> shown below</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c#" data-lang="c#"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> ConfigureServices(IServiceCollection services)
{
    services.AddDbContext&lt;ApplicationDbContext&gt;(options =&gt;
        options.UseSqlServer(
            Configuration.GetConnectionString(<span style="color:#e6db74">&#34;DefaultConnection&#34;</span>)));
    services.AddDefaultIdentity&lt;Models.AppUser&gt;(options =&gt; options.SignIn.RequireConfirmedAccount = <span style="color:#66d9ef">true</span>)
        .AddRoles&lt;IdentityRole&gt;()
        .AddEntityFrameworkStores&lt;ApplicationDbContext&gt;();
    
    services.AddAuthorization(options =&gt;
    {
        options.AddPolicy(<span style="color:#e6db74">&#34;Admins&#34;</span>, policy =&gt;
        {
            policy.RequireRole(<span style="color:#e6db74">&#34;Admin&#34;</span>);
        });
    });

    services.AddRazorPages(options =&gt;
    {
        options.Conventions.AuthorizeFolder(<span style="color:#e6db74">&#34;/Users&#34;</span>);
        options.Conventions.AuthorizeFolder(<span style="color:#e6db74">&#34;/Admin&#34;</span>, <span style="color:#e6db74">&#34;Admins&#34;</span>);

    });
}
</code></pre></div><h2 id="add-and-apply-migrations">Add and apply migrations</h2>
<p>We are pretty much set, now we apply the migrations. In the Package Manager Console, run the command</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">add-migration initial
</code></pre></div><p>The migrations are created and added to the Migration folder</p>


<img src="/images/EfCoreRazorCrud/migrations.webp" class="article-image"  />

<p>Then we can run</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">update-database
</code></pre></div><p>to test the migrations.</p>
<p>If everything is set up correctly, no error will come up and in the <em>SQL Server Object Explorer</em> window of visual studio, you can find the database and tables</p>


<img src="/images/EfCoreRazorCrud/sqlserver.webp" class="article-image"  />

<p>Note that the <code>update-database</code> command creates the database and tables, but is not necessary in our app because <code>UpdateDatabase</code> method, which is defined in <em>Startup.cs</em> in <a href="#seed-data-in-startup">Seed data in startup above</a>, does the same automatically at startup. Therefore, if this project is deployed to a remote server the database and tables are created automatically with seed data.</p>
<p>When testing, another migration useful command is <code>drop-database</code> which deletes the database.</p>
<h2 id="almost-done">Almost Done</h2>
<p>Now from the EF core point of view, we are done.</p>
<h2 id="create-razor-pages">Create Razor pages</h2>
<p>We need to create some pages to finish the app. Create <em>crud</em> folders in Admin and Users folders</p>


<img src="/images/EfCoreRazorCrud/bookcrud_folder.webp" class="article-image"  />

<p>Right-click on <em>Admin/BookCrud</em> folder and <em>Add -&gt; New Scaffolded Item -&gt; Rezor Pages -&gt; Razor Pages Using Entity Frame Work</em>. Choose Book class and ApplicationDbContext as below</p>


<img src="/images/EfCoreRazorCrud/scaffoldBook.webp" class="article-image"  />

<p>Hit <em>create</em> button and visual studio creates Book crud pages</p>


<img src="/images/EfCoreRazorCrud/bookcrud_folder2.webp" class="article-image"  />

<p>Before, you add the scaffolded items for others, change the namespace of new files from <code>EfCoreRazorCrud</code> to <code>EfCoreRazorCrud.Admin.BookCrud</code>. So namespaces coincide with the folders, and new scaffolded items have their own folder, so it won&rsquo;t be confused with the others. Do the same for <em>Admin/PublisherCrud</em> and <em>Users/BookRead</em>: create scaffolded items then change their namespace to their folder. Because users are not allowed to crud, delete <em>Create, Delete, Edit</em> pages and their references.</p>
<h2 id="add-pages-to-_layoutcshtml">Add pages to <em>_Layout.cshtml</em></h2>
<p>To visit these pages, we put their link in <code>_Layout.cshtml</code>. Because we need to know if a visitor is a user, admin or anonymous, the below objects are injected in top of the page</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c#" data-lang="c#">@using Microsoft.AspNetCore.Identity
@inject SignInManager&lt;Models.AppUser&gt; SignInManager
@inject UserManager&lt;Models.AppUser&gt; UserManager
</code></pre></div><p>And where the links are we add</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-html" data-lang="html">&lt;<span style="color:#f92672">li</span> <span style="color:#a6e22e">class</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;nav-item&#34;</span>&gt;
    &lt;<span style="color:#f92672">a</span> <span style="color:#a6e22e">class</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;nav-link text-dark&#34;</span> <span style="color:#a6e22e">asp-area</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;&#34;</span> <span style="color:#a6e22e">asp-page</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;/Index&#34;</span>&gt;Home&lt;/<span style="color:#f92672">a</span>&gt;
&lt;/<span style="color:#f92672">li</span>&gt;
@if (SignInManager.IsSignedIn(User) <span style="color:#960050;background-color:#1e0010">&amp;&amp;</span> User.IsInRole(&#34;Admin&#34;))
{
    &lt;<span style="color:#f92672">li</span> <span style="color:#a6e22e">class</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;nav-item&#34;</span>&gt;
        &lt;<span style="color:#f92672">a</span> <span style="color:#a6e22e">class</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;nav-link text-dark&#34;</span> <span style="color:#a6e22e">asp-area</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;&#34;</span> <span style="color:#a6e22e">asp-page</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;/Admin/BookCrud/Index&#34;</span>&gt;Crud Books&lt;/<span style="color:#f92672">a</span>&gt;
    &lt;/<span style="color:#f92672">li</span>&gt;
    &lt;<span style="color:#f92672">li</span> <span style="color:#a6e22e">class</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;nav-item&#34;</span>&gt;
        &lt;<span style="color:#f92672">a</span> <span style="color:#a6e22e">class</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;nav-link text-dark&#34;</span> <span style="color:#a6e22e">asp-area</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;&#34;</span> <span style="color:#a6e22e">asp-page</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;/Admin/PublisherCrud/Index&#34;</span>&gt;Crud Publisher&lt;/<span style="color:#f92672">a</span>&gt;
    &lt;/<span style="color:#f92672">li</span>&gt;
}
@if (SignInManager.IsSignedIn(User))
{
    &lt;<span style="color:#f92672">li</span> <span style="color:#a6e22e">class</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;nav-item&#34;</span>&gt;
        &lt;<span style="color:#f92672">a</span> <span style="color:#a6e22e">class</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;nav-link text-dark&#34;</span> <span style="color:#a6e22e">asp-area</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;&#34;</span> <span style="color:#a6e22e">asp-page</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;/Users/BookRead/Index&#34;</span>&gt;See Books&lt;/<span style="color:#f92672">a</span>&gt;
    &lt;/<span style="color:#f92672">li</span>&gt;
}
</code></pre></div><p>So admin can crud but users only can see the books.</p>
<h2 id="run-the-app">Run the app</h2>
<p>Now we can run the app, and use the Admin email and password mentioned in <code>SeedData</code> to login, then crud Books and Publishers. There is just one gotcha</p>


<img src="/images/EfCoreRazorCrud/publisher_id.webp" class="article-image"  />

<h2 id="show-names-instead-of-ids">Show names instead of id&rsquo;s</h2>
<p>We don&rsquo;t want to see publisher id. We want to see the name of the publisher, so in Admin/BookCrud/Index.cshtml and Users/BookRead/Index.cshtml change</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c#" data-lang="c#">@Html.DisplayFor(modelItem =&gt; item.Publisher.Id)
</code></pre></div><p>to</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c#" data-lang="c#">@Html.DisplayFor(modelItem =&gt; item.Publisher.Name)
</code></pre></div><p>There is one more problem in Admin/BookCrud/Create page, still publisher id appears</p>


<img src="/images/EfCoreRazorCrud/bookcreatepage.webp" class="article-image"  />

<p>To fix this, in the code behind of  Admin/BookCrud/Create change</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c#" data-lang="c#">ViewData[<span style="color:#e6db74">&#34;PublisherId&#34;</span>] = <span style="color:#66d9ef">new</span> SelectList(_context.Publishers, <span style="color:#e6db74">&#34;Id&#34;</span>, <span style="color:#e6db74">&#34;Id&#34;</span>);
</code></pre></div><p>to</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c#" data-lang="c#">ViewData[<span style="color:#e6db74">&#34;PublisherId&#34;</span>] = <span style="color:#66d9ef">new</span> SelectList(_context.Publishers, <span style="color:#e6db74">&#34;Id&#34;</span>, <span style="color:#e6db74">&#34;Name&#34;</span>);
</code></pre></div><p>Now you should see the name of publishers to select rather than their Id.</p>
<h2 id="code-on-github">Code on Github</h2>
<p>If face any problem, you can compare your project with mine on <a href="https://github.com/sorush-khajepor/EfCoreRazorCrud">Github</a>.</p>

			
			<script>
				window.onscroll = function () {
					myFunction();
				};
				function myFunction() {
					var winScroll = document.body.scrollTop || document.documentElement.scrollTop;
					var height = document.documentElement.scrollHeight - document.documentElement.clientHeight;
					var scrolled = (winScroll / height) * 100;
					document.getElementById("myBar").style.width = scrolled + "%";
				}
			</script>
			<hr style="width:5%;text-align:left;margin-left:0;margin-top: 3em;border-top: 3px solid rgb(87, 86, 86);
			border-radius: 5px;">
			


  <h3>Related Tags</h3>
    <div id="tags">
        
        <span><a href="/tags/c-sharp">C Sharp</a> </span>
        
        <span><a href="/tags/back-end-web">Back-end Web</a> </span>
        
    </div>



			<hr style="width:5%;text-align:left;margin-left:0;margin-top: 3em;border-top: 3px solid rgb(87, 86, 86);
			border-radius: 5px;">
			
<div>
	<h3>Latest Posts</h3>
</div>
<div>
	<ul>
		
		<li><a href="/posts/mpi-race-condition/">MPI race condition</a></li>
		
		<li><a href="/posts/mpi-ping-pong/">MPI ping pong program using C&#43;&#43;</a></li>
		
		<li><a href="/posts/linux-connection-packages/">Handy free Windows packages to connect to a remote Linux server</a></li>
		
		<li><a href="/posts/mpi-send-types/">The difference between modes of MPI send</a></li>
		
		<li><a href="/posts/all-about-template/">C&#43;&#43; template crash course</a></li>
		
	</ul>
</div>
	
		</article>
		<nav class="hide-on-mobile section-nav">
			<h3 class="ml-1">Table of contents</h3>
			<nav id="TableOfContents">
  <ul>
    <li><a href="#goal">Goal</a></li>
    <li><a href="#result">Result</a></li>
    <li><a href="#create-project">Create Project</a></li>
    <li><a href="#create-ef-models">Create EF Models</a></li>
    <li><a href="#publisher-model">Publisher Model</a></li>
    <li><a href="#book-model">Book Model</a></li>
    <li><a href="#appuser-model">AppUser Model</a></li>
    <li><a href="#appuser-in-startup">AppUser in Startup</a></li>
    <li><a href="#applicationdbcontext">ApplicationDbContext</a></li>
    <li><a href="#seed-data">Seed data</a></li>
    <li><a href="#seed-data-in-startup">Seed data in Startup</a></li>
    <li><a href="#create-authorized-folders">Create authorized folders</a></li>
    <li><a href="#add-and-apply-migrations">Add and apply migrations</a></li>
    <li><a href="#almost-done">Almost Done</a></li>
    <li><a href="#create-razor-pages">Create Razor pages</a></li>
    <li><a href="#add-pages-to-_layoutcshtml">Add pages to <em>_Layout.cshtml</em></a></li>
    <li><a href="#run-the-app">Run the app</a></li>
    <li><a href="#show-names-instead-of-ids">Show names instead of id&rsquo;s</a></li>
    <li><a href="#code-on-github">Code on Github</a></li>
  </ul>
</nav>
		</nav>		
	</div>
</main>
<script>
	window.addEventListener('DOMContentLoaded', () => {
		const observerForTableOfContentActiveState = new IntersectionObserver(entries => {
			entries.forEach(entry => {
				const id = entry.target.getAttribute('id');

				if (entry.intersectionRatio > 0) {					
					clearActiveStatesInTableOfContents();				
					document.querySelector(`nav li a[href="#${id}"]`).parentElement.classList.add('active');
				}
			});
		});		
		document.querySelectorAll('h1[id],h2[id],h3[id],h4[id]').forEach((section) => {
			observerForTableOfContentActiveState.observe(section);
		});

	});

	function clearActiveStatesInTableOfContents() {
		document.querySelectorAll('nav li').forEach((section) => {
			section.classList.remove('active');
		});
	}
</script>
 <footer>
    <div class="container">
	<div class="my-2">
	<form name="Subscription" method="POST" data-netlify="true" netlify-honeypot="ahani" action="/pages/sub-success">
		<p class="nedia">
		  <label> Name <input name="ahani" /></label>
		</p>
		<p><label for="emailinput">Subscribe so I notify you of new posts</label></p>
		<p class="display-flex">
		  <input id="emailinput" style="width: 18em;" class="mr-1" type="email" name="email" placeholder=" Email"/>
		  <button type="submit">Subscribe</button>
		</p>
	</form>
</div>
<div class="my-1 display-flex justify-start justify-md-end align-center">
	<p>Copyright &copy; 2020 <a href="https://iamsorush.com/">Sorush Khajepor</a></p>
</div>
</div>
</footer>



  
</body>

</html>